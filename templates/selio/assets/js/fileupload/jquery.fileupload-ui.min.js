!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","tmpl","load-image","./jquery.fileupload-fp"],e):e(window.jQuery,window.tmpl,window.loadImage)}(function(d,t,o){"use strict";d.widget("blueimp.fileupload",d.blueimp.fileupload,{options:{autoUpload:!1,maxNumberOfFiles:void 0,maxFileSize:void 0,minFileSize:void 0,acceptFileTypes:/.+$/i,previewSourceFileTypes:/^image\/(gif|jpeg|png)$/,previewSourceMaxFileSize:5e6,previewMaxWidth:80,previewMaxHeight:80,previewAsCanvas:!0,uploadTemplateId:"template-upload",downloadTemplateId:"template-download",filesContainer:void 0,prependFiles:!1,dataType:"json",add:function(e,t){var i=d(this).data("blueimp-fileupload")||d(this).data("fileupload"),n=i.options,r=t.files;d(this).fileupload("process",t).done(function(){i._adjustMaxNumberOfFiles(-r.length),t.maxNumberOfFilesAdjusted=!0,t.files.valid=t.isValidated=i._validate(r),t.context=i._renderUpload(r).data("data",t),n.filesContainer[n.prependFiles?"prepend":"append"](t.context),i._renderPreviews(t),i._forceReflow(t.context),i._transition(t.context).done(function(){!1!==i._trigger("added",e,t)&&(n.autoUpload||t.autoUpload)&&!1!==t.autoUpload&&t.isValidated&&t.submit()})})},send:function(e,t){var i=d(this).data("blueimp-fileupload")||d(this).data("fileupload");return!(!t.isValidated&&(t.maxNumberOfFilesAdjusted||(i._adjustMaxNumberOfFiles(-t.files.length),t.maxNumberOfFilesAdjusted=!0),!i._validate(t.files)))&&(t.context&&t.dataType&&"iframe"===t.dataType.substr(0,6)&&t.context.find(".progress").addClass(!d.support.transition&&"progress-animated").attr("aria-valuenow",100).find(".bar").css("width","100%"),i._trigger("sent",e,t))},done:function(n,r){var o,e,s=d(this).data("blueimp-fileupload")||d(this).data("fileupload"),a=s._getFilesFromResponse(r);r.context?r.context.each(function(e){var t=a[e]||{error:"Empty file upload result"},i=s._addFinishedDeferreds();t.error&&s._adjustMaxNumberOfFiles(1),s._transition(d(this)).done(function(){var e=d(this);o=s._renderDownload([t]).replaceAll(e),s._forceReflow(o),s._transition(o).done(function(){r.context=d(this),s._trigger("completed",n,r),s._trigger("finished",n,r),i.resolve()})})}):(a.length&&(d.each(a,function(e,t){r.maxNumberOfFilesAdjusted&&t.error?s._adjustMaxNumberOfFiles(1):r.maxNumberOfFilesAdjusted||t.error||s._adjustMaxNumberOfFiles(-1)}),r.maxNumberOfFilesAdjusted=!0),o=s._renderDownload(a).appendTo(s.options.filesContainer),s._forceReflow(o),e=s._addFinishedDeferreds(),s._transition(o).done(function(){r.context=d(this),s._trigger("completed",n,r),s._trigger("finished",n,r),e.resolve()}))},fail:function(i,n){var r,o,s=d(this).data("blueimp-fileupload")||d(this).data("fileupload");n.maxNumberOfFilesAdjusted&&s._adjustMaxNumberOfFiles(n.files.length),n.context?n.context.each(function(e){if("abort"!==n.errorThrown){var t=n.files[e];t.error=t.error||n.errorThrown||!0,o=s._addFinishedDeferreds(),s._transition(d(this)).done(function(){var e=d(this);r=s._renderDownload([t]).replaceAll(e),s._forceReflow(r),s._transition(r).done(function(){n.context=d(this),s._trigger("failed",i,n),s._trigger("finished",i,n),o.resolve()})})}else o=s._addFinishedDeferreds(),s._transition(d(this)).done(function(){d(this).remove(),s._trigger("failed",i,n),s._trigger("finished",i,n),o.resolve()})}):"abort"!==n.errorThrown?(n.context=s._renderUpload(n.files).appendTo(s.options.filesContainer).data("data",n),s._forceReflow(n.context),o=s._addFinishedDeferreds(),s._transition(n.context).done(function(){n.context=d(this),s._trigger("failed",i,n),s._trigger("finished",i,n),o.resolve()})):(s._trigger("failed",i,n),s._trigger("finished",i,n),s._addFinishedDeferreds().resolve())},progress:function(e,t){if(t.context){var i=parseInt(t.loaded/t.total*100,10);t.context.find(".progress").attr("aria-valuenow",i).find(".bar").css("width",i+"%")}},progressall:function(e,t){var i=d(this),n=parseInt(t.loaded/t.total*100,10),r=i.find(".fileupload-progress"),o=r.find(".progress-extended");o.length&&o.html((i.data("blueimp-fileupload")||i.data("fileupload"))._renderExtendedProgress(t)),r.find(".progress").attr("aria-valuenow",n).find(".bar").css("width",n+"%")},start:function(e){var t=d(this).data("blueimp-fileupload")||d(this).data("fileupload");t._resetFinishedDeferreds(),t._transition(d(this).find(".fileupload-progress")).done(function(){t._trigger("started",e)})},stop:function(e){var t=d(this).data("blueimp-fileupload")||d(this).data("fileupload"),i=t._addFinishedDeferreds();d.when.apply(d,t._getFinishedDeferreds()).done(function(){t._trigger("stopped",e)}),t._transition(d(this).find(".fileupload-progress")).done(function(){d(this).find(".progress").attr("aria-valuenow","0").find(".bar").css("width","0%"),d(this).find(".progress-extended").html("&nbsp;"),i.resolve()})},destroy:function(t,e){var i=d(this).data("blueimp-fileupload")||d(this).data("fileupload");e.url&&(d.ajax(e).done(function(e){e.hasOwnProperty("success")&&e.success&&d(this).remove(),i._trigger("destroyed",t,e)}).fail(function(){alert("error during ajax call")}),i._adjustMaxNumberOfFiles(1))}},_resetFinishedDeferreds:function(){this._finishedUploads=[]},_addFinishedDeferreds:function(e){return e=e||d.Deferred(),this._finishedUploads.push(e),e},_getFinishedDeferreds:function(){return this._finishedUploads},_getFilesFromResponse:function(e){return e.result&&d.isArray(e.result.files)?e.result.files:[]},_enableDragToDesktop:function(){var e=d(this),t=e.prop("href"),i=e.prop("download"),n="application/octet-stream";e.bind("dragstart",function(e){try{e.originalEvent.dataTransfer.setData("DownloadURL",[n,i,t].join(":"))}catch(e){}})},_adjustMaxNumberOfFiles:function(e){"number"==typeof this.options.maxNumberOfFiles&&(this.options.maxNumberOfFiles+=e,this.options.maxNumberOfFiles<1?this._disableFileInputButton():this._enableFileInputButton())},_formatFileSize:function(e){return"number"!=typeof e?"":1e9<=e?(e/1e9).toFixed(2)+" GB":1e6<=e?(e/1e6).toFixed(2)+" MB":(e/1e3).toFixed(2)+" KB"},_formatBitrate:function(e){return"number"!=typeof e?"":1e9<=e?(e/1e9).toFixed(2)+" Gbit/s":1e6<=e?(e/1e6).toFixed(2)+" Mbit/s":1e3<=e?(e/1e3).toFixed(2)+" kbit/s":e.toFixed(2)+" bit/s"},_formatTime:function(e){var t=new Date(1e3*e),i=parseInt(e/86400,10);return(i=i?i+"d ":"")+("0"+t.getUTCHours()).slice(-2)+":"+("0"+t.getUTCMinutes()).slice(-2)+":"+("0"+t.getUTCSeconds()).slice(-2)},_formatPercentage:function(e){return(100*e).toFixed(2)+" %"},_renderExtendedProgress:function(e){return this._formatBitrate(e.bitrate)+" | "+this._formatTime(8*(e.total-e.loaded)/e.bitrate)+" | "+this._formatPercentage(e.loaded/e.total)+" | "+this._formatFileSize(e.loaded)+" / "+this._formatFileSize(e.total)},_hasError:function(e){return e.error?e.error:this.options.maxNumberOfFiles<0?"Maximum number of files exceeded":this.options.acceptFileTypes.test(e.type)||this.options.acceptFileTypes.test(e.name)?this.options.maxFileSize&&e.size>this.options.maxFileSize?"File is too big":"number"==typeof e.size&&e.size<this.options.minFileSize?"File is too small":null:"Filetype not allowed"},_validate:function(e){var i=this,n=!!e.length;return d.each(e,function(e,t){t.error=i._hasError(t),t.error&&(n=!1)}),n},_renderTemplate:function(e,t){if(!e)return d();var i=e({files:t,formatFileSize:this._formatFileSize,options:this.options});return i instanceof d?i:d(this.options.templatesContainer).html(i).children()},_renderPreview:function(e,t){var i=this,n=this.options,r=d.Deferred();return(o&&o(e,function(e){t.append(e),i._forceReflow(t),i._transition(t).done(function(){r.resolveWith(t)}),d.contains(i.document[0].body,t[0])||r.resolveWith(t)},{maxWidth:n.previewMaxWidth,maxHeight:n.previewMaxHeight,canvas:n.previewAsCanvas})||r.resolveWith(t))&&r},_renderPreviews:function(r){var o=this,t=this.options;return r.context.find(".preview span").each(function(e,i){var n=r.files[e];t.previewSourceFileTypes.test(n.type)&&("number"!==d.type(t.previewSourceMaxFileSize)||n.size<t.previewSourceMaxFileSize)&&(o._processingQueue=o._processingQueue.pipe(function(){var e=d.Deferred(),t=d.Event("previewdone",{target:i});return o._renderPreview(n,d(i)).done(function(){o._trigger(t.type,t,r),e.resolveWith(o)}),e.promise()}))}),this._processingQueue},_renderUpload:function(e){return this._renderTemplate(this.options.uploadTemplate,e)},_renderDownload:function(e){return this._renderTemplate(this.options.downloadTemplate,e).find("a[download]").each(this._enableDragToDesktop).end()},_startHandler:function(e){e.preventDefault();var t=d(e.currentTarget),i=t.closest(".template-upload").data("data");i&&i.submit&&!i.jqXHR&&i.submit()&&t.prop("disabled",!0)},_cancelHandler:function(e){e.preventDefault();var t=d(e.currentTarget).closest(".template-upload").data("data")||{};t.jqXHR?t.jqXHR.abort():(t.errorThrown="abort",this._trigger("fail",e,t))},_deleteHandler:function(e){e.preventDefault();var t=d(e.currentTarget);this._trigger("destroy",e,d.extend({context:t.closest(".template-download"),type:"DELETE",dataType:this.options.dataType},t.data()))},_forceReflow:function(e){return d.support.transition&&e.length&&e[0].offsetWidth},_transition:function(t){var i=d.Deferred();return d.support.transition&&t.hasClass("fade")?t.bind(d.support.transition.end,function(e){e.target===t[0]&&(t.unbind(d.support.transition.end),i.resolveWith(t))}).toggleClass("in"):(t.toggleClass("in"),i.resolveWith(t)),i},_initButtonBarEventHandlers:function(){var t=this.element.find(".fileupload-buttonbar"),i=this.options.filesContainer;this._on(t.find(".start"),{click:function(e){e.preventDefault(),i.find(".start button").click()}}),this._on(t.find(".cancel"),{click:function(e){e.preventDefault(),i.find(".cancel button").click()}}),this._on(t.find(".delete"),{click:function(e){e.preventDefault(),i.find(".delete input:checked").siblings("button").click(),t.find(".toggle").prop("checked",!1)}}),this._on(t.find(".toggle"),{change:function(e){i.find(".delete input").prop("checked",d(e.currentTarget).is(":checked"))}})},_destroyButtonBarEventHandlers:function(){this._off(this.element.find(".fileupload-buttonbar button"),"click"),this._off(this.element.find(".fileupload-buttonbar .toggle"),"change.")},_initEventHandlers:function(){this._super(),this._on(this.options.filesContainer,{"click .start button":this._startHandler,"click .cancel button":this._cancelHandler,"click .delete button":this._deleteHandler}),this._initButtonBarEventHandlers()},_destroyEventHandlers:function(){this._destroyButtonBarEventHandlers(),this._off(this.options.filesContainer,"click"),this._super()},_enableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",!1).parent().removeClass("disabled")},_disableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",!0).parent().addClass("disabled")},_initTemplates:function(){var e=this.options;e.templatesContainer=this.document[0].createElement(e.filesContainer.prop("nodeName")),t&&(e.uploadTemplateId&&(e.uploadTemplate=t(e.uploadTemplateId)),e.downloadTemplateId&&(e.downloadTemplate=t(e.downloadTemplateId)))},_initFilesContainer:function(){var e=this.options;void 0===e.filesContainer?e.filesContainer=this.element.find(".files"):e.filesContainer instanceof d||(e.filesContainer=d(e.filesContainer))},_stringToRegExp:function(e){var t=e.split("/"),i=t.pop();return t.shift(),new RegExp(t.join("/"),i)},_initRegExpOptions:function(){var e=this.options;"string"===d.type(e.acceptFileTypes)&&(e.acceptFileTypes=this._stringToRegExp(e.acceptFileTypes)),"string"===d.type(e.previewSourceFileTypes)&&(e.previewSourceFileTypes=this._stringToRegExp(e.previewSourceFileTypes))},_initSpecialOptions:function(){this._super(),this._initFilesContainer(),this._initTemplates(),this._initRegExpOptions()},_setOption:function(e,t){this._super(e,t),"maxNumberOfFiles"===e&&this._adjustMaxNumberOfFiles(0)},_create:function(){this._super(),this._refreshOptionsList.push("filesContainer","uploadTemplateId","downloadTemplateId"),this._processingQueue||(this._processingQueue=d.Deferred().resolveWith(this).promise(),this.process=function(){return this._processingQueue}),this._resetFinishedDeferreds()},enable:function(){var e=!1;this.options.disabled&&(e=!0),this._super(),e&&(this.element.find("input, button").prop("disabled",!1),this._enableFileInputButton())},disable:function(){this.options.disabled||(this.element.find("input, button").prop("disabled",!0),this._disableFileInputButton()),this._super()}})});